<!DOCTYPE html>
<html>
<head>
  <title>Mainfo</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <link rel="stylesheet" href="dist/leaflet.label.css"/>
  <link rel="stylesheet" href="dist/panel.css"/>
  <link rel="stylesheet" href="dist/scale.css"/>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
  <script src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
  <script src="http://underscorejs.org/underscore.js"></script>
  <style>

  body {
    padding: 0;
    margin: 0;
  }
  html, body, #map {
    height: 100%;
    width: 100%;
  }
  .update {
    position: absolute;
    padding: 6px 8px;
    font: 14px/16px Arial, Helvetica, sans-serif;
    color: #223;
    background-color: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    z-index:2000;
    right: 0px;
    bottom: 20px;
  }
  .labelvillages
  {
    color: #111;
    display: block;
    font: 10px/20px "Helvetica Neue", Arial, Helvetica, sans-serif;
    z-index: 6;
  }
  .leaflet-control-layers-expanded {
    background: rgba(250, 250, 250, 0.7) none repeat scroll 0 0;
    color: #333;
    padding: 6px 10px 6px 6px;
  }
  </style>
</head>
<body>

  <div class="update"></div>
  <div id="map"></div>

  <!-- <script src="../node_modules/simpleheat/simpleheat.js"></script>
  <script src="../src/HeatLayer.js"></script> -->

  <script src="src/HeatLayer.js"></script>
  <script src="src/heatmap2.js"></script>
  <script src="src/simpleheat.js"></script>
  <script src="src/Label.js"></script>
  <script src="src/BaseMarkerMethods.js"></script>
  <script src="src/Marker.Label.js"></script>
  <script src="src/CircleMarker.Label.js"></script>
  <script src="src/Path.Label.js"></script>
  <script src="src/Map.Label.js"></script>
  <script src="src/FeatureGroup.Label.js"></script>
  <script src="src/panel.js"></script>
  <script src="src/scale.js"></script>


  <!--<script src="http://leaflet.github.io/Leaflet.markercluster/example/realworld.10000.js"></script>-->

  <script>


  $.getJSON("http://raw.githubusercontent.com/mainfo/data/master/data.json", function(data) {
    var heat = [];
    var last_update = data.last_update;
    $(".update").html("Last update of the map: " + last_update);

    //Get all the coodinates in one object
    var lsp = [];
    var geojsonheat = L.geoJson(data, {
      onEachFeature: function (feature, layer) {
        var lng = feature.geometry.coordinates[0];
        var lat = feature.geometry.coordinates[1];
        var date_add = feature.properties.date_add;
        obj = {
          name: lng+"_"+lat,
          lat: lat,
          lng:lng
        };
        lsp.push(obj);
      }
    });

    //Get the count of report for each point
    var gpby = _.groupBy(lsp,'name');

    //Create  an object of the count of record per coordinates couple
    var reduce =[];
    $.each(gpby, function( index, value ) {
      ind = index.split("_");
      obj2 = {
        lng : ind[0],
        lat: ind[1],
        count:Math.sqrt(value.length)+5
      };
      //var result = [+ind[1],+ind[0],String(value.length)];
      reduce.push(obj2);
    });

    //Get the layer OSM cities and town
    var features_cities_and_towns = "";
    var features_villages ="";
    //CAll to the Overpass API
    $.getJSON("http://overpass-api.de/api/interpreter?data=%5Bout%3Ajson%5D%3B%0A%28%0A%20%20node%5B%22place%22~%22city%7Ctown%7Cvillage%22%5D%2816.18038632955662%2C106.578369140625%2C17.456235599424733%2C107.83355712890625%29%3B%0A%29%3B%0Aout%20body%3B%0A%3E%3B%0Aout%20skel%20qt%3B", function(cities_result) {
      cities_all = cities_result.elements;
      features_cities = [];
      features_vill = [];
      $.each(cities_all, function( index, value ) {
        //console.log(index, value);
        var place = { id:index,lat:value.lat,lng:value.lon,name:value.tags.name,place:value.tags.place} ;
        if(value.tags.place == "city"||value.tags.place=="town"){
          //Create marker for cities and towns
          var circle_city = L.circleMarker([value.lat, value.lon], { fillColor: "#fff", color:"#000",radius: 4 }).bindLabel(value.tags.name, { noHide: true });
          features_cities.push(circle_city);
        }
        if(value.tags.place == "village"){
          //Create marker for villages
          var circle_villages = L.circleMarker([value.lat, value.lon],{ fillColor: "#fff", color:"#000",radius: 4 }).bindLabel(value.tags.name,{className:"labelvillages",noHide: true ,direction:"auto"});
          features_vill.push(circle_villages);
        };
      });

      features_cities_and_towns = L.featureGroup(features_cities);
      features_villages = L.featureGroup(features_vill);

      //cities.push(JSON.stringify(features)
      //cities = JSON.stringify(cities).replace("'","");
      //console.log(features);
      var hotData = {
        max: 13,
        data: reduce
      };
      var cfg = {
        // radius should be small ONLY if scaleRadius is true (or small radius is intended)
        // if scaleRadius is false it will be the constant radius used in pixels
        "radius": 50,
        "maxOpacity": .9,
        // scales the radius based on map zoom
        "scaleRadius": false,
        // if set to false the heatmap uses the global maximum for colorization
        // if activated: uses the data maximum within the current map boundaries
        //   (there will always be a red spot with useLocalExtremas true)
        "useLocalExtrema": false,
        // which field name in your data represents the latitude - default "lat"
        latField: 'lat',
        // which field name in your data represents the longitude - default "lng"
        lngField: 'lng',
        // which field name in your data represents the data value - default "value"
        valueField: 'count',
        //gradient:{0.2:'#01ABE9',0.6:'#C3CED0',0.7: '#F54B1A'}
        //gradient:{0.1:'#01ABE9',0.5:'#1B346C',0.6:'#F54B1A',0.8: '#01ABE9',1:'#01ABE9'}
      };


      var heatmapLayer = new HeatmapOverlay(cfg);

      var OpenStreetMap_HOT = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
      });

      //From Mapbox
      var labels = L.tileLayer('http://{s}.tiles.mapbox.com/v4/mainfo.f3xwp14i/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFpbmZvIiwiYSI6ImRjMGNmMGE5ZjczYzc2NDU0MmFlNWQ3NThiYzRkYmRhIn0.Z9ZkL0wyzGyOyGMkcyFU1w');

      var tiles = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      })


      var districts = L.tileLayer('http://{s}.tiles.mapbox.com/v4/mainfo.7tz6ko6r/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFpbmZvIiwiYSI6ImRjMGNmMGE5ZjczYzc2NDU0MmFlNWQ3NThiYzRkYmRhIn0.Z9ZkL0wyzGyOyGMkcyFU1w');

      //var heatLayer = L.heatLayer(reduce,{radius: 20,blur: 30, maxZoom: 12});

      //var heatmapLayer = L.heatLayer(reduce,{radius: 40,blur: 40});//gradient:{0.1:'#edf8fb',0.5:'#b3cde3',0.6:'#8c96c6',0.8: '#88419d'}

      var baseMaps = {
        "ESRI Satellite": tiles,
        "Humanitarian Open Street Map (OSM)":OpenStreetMap_HOT
      };

      var overlayMaps = {
        "Heat map of the reports collected": heatmapLayer,
        "Districts boundaries" : districts,
        "Cities from OSM": features_cities_and_towns,
        "Villages from OSM":features_villages

      };

      //Restric to bounds
      var southWest = L.latLng(16.531606,107.0103),
      northEast = L.latLng(16.801204,108.41921),
      bounds = L.latLngBounds(southWest, northEast);

      var map = L.map('map',{maxZoom: 13,minZoom:12, maxBounds: bounds,layers: [tiles,features_cities_and_towns,heatmapLayer,districts]}).setView([16.68, 107.3], 12);

      heatmapLayer.setData(hotData);

      L.control.layers(baseMaps, overlayMaps,{collapsed:false}).addTo(map);
       var graphicScale = L.control.graphicScale({fill:'fill'}).addTo(map);
      //var panelLayers = new L.Control.PanelLayers(baseLayers, overLayers);

      //map.addControl(panelLayers);

      //Supre le overlays machin.. Lorsque kle zoom est à 13 alors on met les villages.. losrqu'on passs à OSM on enleve les etiquette...
      map.on('zoomend', function (e) {
        myZoomHandler();
      });

      function myZoomHandler() {
        var currentZoom = map.getZoom();
        switch (currentZoom) {
          case 12:
          if (map.hasLayer(features_villages)) {
            map.removeLayer(features_villages);
          }
          //map.removeLayer(features_villages);panelLayers._update();
          $( "span:contains('Villages')").siblings().attr('disabled','disabled');
          $( "span:contains('Villages')").parent().css("background-color","rgba(0, 0, 0, 0.3)");
          break;
          case 13:
          $( "span:contains('Villages')").siblings().removeAttr('disabled');;
          $( "span:contains('Villages')").parent().css("background-color","rgba(250, 250, 250, 1)");
          break;
          default:
          $( "span:contains('Villages')").siblings().attr('disabled','disabled');
          $( "span:contains('Villages')").parent().css("background-color","rgba(0, 0, 0, 0.3)");
          break;
        }
      }
      //On load
      $( "span:contains('Villages')").siblings().attr('disabled','disabled');
      $( "span:contains('Villages')").parent().css("background-color","rgba(0, 0, 0, 0.3)");

      //Late CSS custom
      $( "span:contains('Label')").css("font-weight","bold").css("color","#000");
      $( "span:contains('Reports')").css("font-weight","bold").css("color","#000");
      $( "span:contains('Background')").css("font-weight","bold").css("color","#000");

    });



    console.log(reduce);

  });



  </script>
</body>
</html>
